<div class="global-settings-tab">
  @if (settingsLoading()) {
    <div class="global-settings-tab__loading">Loading settings...</div>
  } @else if (settingsError()) {
    <div class="global-settings-tab__error">{{ settingsError() }}</div>
  } @else {
    <div class="global-settings-tab__sections">
      <div class="global-settings-tab__section">
        <h2 class="global-settings-tab__section-title">General Settings</h2>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Site Name</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('site_name')"
              (ngModelChange)="updateSetting('site_name', $event)"
              placeholder="Site name" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('site_name', getSettingValue('site_name'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <div class="global-settings-tab__setting-input">
            <label class="global-settings-tab__label">Default Season</label>
            <tui-textfield tuiChevron>
              <select
                tuiSelect
                [ngModel]="getSettingValue('default_season_id')"
                (ngModelChange)="updateSetting('default_season_id', $event)">
                @for (season of seasons(); track season.id) {
                  <option [value]="season.id">{{ season.year }}</option>
                }
              </select>
              <tui-data-list *tuiTextfieldDropdown>
                @for (season of seasons(); track season.id) {
                  <button new tuiOption [value]="season.id">
                    {{ season.year }}
                  </button>
                }
              </tui-data-list>
            </tui-textfield>
          </div>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Timezone</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('timezone')"
              (ngModelChange)="updateSetting('timezone', $event)"
              placeholder="Timezone" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('timezone', getSettingValue('timezone'))">
            Save
          </button>
        </div>
      </div>

      <div class="global-settings-tab__section">
        <h2 class="global-settings-tab__section-title">Registration Settings</h2>

        <div class="global-settings-tab__setting-row global-settings-tab__setting-row--checkbox">
          <label class="global-settings-tab__checkbox-label">
            <input
              type="checkbox"
              [ngModel]="getSettingValue('allow_public_registration') === 'true'"
              (change)="onCheckboxChange('allow_public_registration', $event)" />
            <span>Allow Public Registration</span>
          </label>
        </div>

        <div class="global-settings-tab__setting-row global-settings-tab__setting-row--checkbox">
          <label class="global-settings-tab__checkbox-label">
            <input
              type="checkbox"
              [ngModel]="getSettingValue('require_email_verification') === 'true'"
              (change)="onCheckboxChange('require_email_verification', $event)" />
            <span>Require Email Verification</span>
          </label>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Default User Role</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('default_user_role')"
              (ngModelChange)="updateSetting('default_user_role', $event)"
              placeholder="Default user role" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('default_user_role', getSettingValue('default_user_role'))">
            Save
          </button>
        </div>
      </div>

      <div class="global-settings-tab__section">
        <h2 class="global-settings-tab__section-title">Email Settings</h2>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>SMTP Server</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('smtp_server')"
              (ngModelChange)="updateSetting('smtp_server', $event)"
              placeholder="SMTP server" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('smtp_server', getSettingValue('smtp_server'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>SMTP Port</label>
            <input
              type="number"
              tuiTextfield
              [ngModel]="getSettingValue('smtp_port')"
              (ngModelChange)="updateSetting('smtp_port', $event)"
              placeholder="SMTP port" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('smtp_port', getSettingValue('smtp_port'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>SMTP Username</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('smtp_username')"
              (ngModelChange)="updateSetting('smtp_username', $event)"
              placeholder="SMTP username" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('smtp_username', getSettingValue('smtp_username'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>SMTP Password</label>
            <input
              type="password"
              tuiTextfield
              [ngModel]="getSettingValue('smtp_password')"
              (ngModelChange)="updateSetting('smtp_password', $event)"
              placeholder="SMTP password" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('smtp_password', getSettingValue('smtp_password'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Sender Email</label>
            <input
              type="email"
              tuiTextfield
              [ngModel]="getSettingValue('sender_email')"
              (ngModelChange)="updateSetting('sender_email', $event)"
              placeholder="Sender email" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('sender_email', getSettingValue('sender_email'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Sender Name</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('sender_name')"
              (ngModelChange)="updateSetting('sender_name', $event)"
              placeholder="Sender name" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('sender_name', getSettingValue('sender_name'))">
            Save
          </button>
        </div>
      </div>

      <div class="global-settings-tab__section">
        <h2 class="global-settings-tab__section-title">Storage Settings</h2>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Max File Upload Size (MB)</label>
            <input
              type="number"
              tuiTextfield
              [ngModel]="getSettingValue('max_file_upload_size_mb')"
              (ngModelChange)="updateSetting('max_file_upload_size_mb', $event)"
              placeholder="Max upload size" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('max_file_upload_size_mb', getSettingValue('max_file_upload_size_mb'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Allowed Image Formats</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('allowed_image_formats')"
              (ngModelChange)="updateSetting('allowed_image_formats', $event)"
              placeholder="JPG, PNG, WEBP" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('allowed_image_formats', getSettingValue('allowed_image_formats'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Static Files Path</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('static_files_path')"
              (ngModelChange)="updateSetting('static_files_path', $event)"
              placeholder="Static files path" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('static_files_path', getSettingValue('static_files_path'))">
            Save
          </button>
        </div>
      </div>

      <div class="global-settings-tab__section">
        <h2 class="global-settings-tab__section-title">API Settings</h2>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>Rate Limit (requests/min)</label>
            <input
              type="number"
              tuiTextfield
              [ngModel]="getSettingValue('rate_limit_per_minute')"
              (ngModelChange)="updateSetting('rate_limit_per_minute', $event)"
              placeholder="Rate limit" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('rate_limit_per_minute', getSettingValue('rate_limit_per_minute'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row">
          <tui-textfield class="global-settings-tab__setting-input">
            <label tuiLabel>API Version</label>
            <input
              type="text"
              tuiTextfield
              [ngModel]="getSettingValue('api_version')"
              (ngModelChange)="updateSetting('api_version', $event)"
              placeholder="API version" />
          </tui-textfield>
          <button
            type="button"
            tuiButton
            appearance="primary"
            (click)="updateSetting('api_version', getSettingValue('api_version'))">
            Save
          </button>
        </div>

        <div class="global-settings-tab__setting-row global-settings-tab__setting-row--checkbox">
          <label class="global-settings-tab__checkbox-label">
            <input
              type="checkbox"
              [ngModel]="getSettingValue('enable_api_documentation') === 'true'"
              (change)="onCheckboxChange('enable_api_documentation', $event)" />
            <span>Enable API Documentation</span>
          </label>
        </div>
      </div>

      <div class="global-settings-tab__section">
        <div class="global-settings-tab__section-header">
          <h2 class="global-settings-tab__section-title">Seasons</h2>
          <button
            type="button"
            tuiButton
            appearance="primary"
            iconStart="@tui.plus"
            (click)="openSeasonForm()">
            Add Season
          </button>
        </div>

        @if (seasonsLoading()) {
          <div class="global-settings-tab__loading">Loading seasons...</div>
        } @else if (seasons().length === 0) {
          <div class="global-settings-tab__empty">No seasons found</div>
        } @else {
          <div class="global-settings-tab__seasons-list">
            @for (season of sortedSeasons(); track season.id) {
              <div class="global-settings-tab__season-item">
                <div class="global-settings-tab__season-info">
                  <span class="global-settings-tab__season-year">{{ season.year }}</span>
                  @if (season.description) {
                    <span class="global-settings-tab__season-description">{{ season.description }}</span>
                  }
                  @if (season.iscurrent) {
                    <span class="global-settings-tab__season-badge">Current</span>
                  }
                </div>
                <div class="global-settings-tab__season-actions">
                  <button
                    type="button"
                    tuiButton
                    appearance="flat"
                    size="s"
                    (click)="openSeasonForm(season)"
                    class="global-settings-tab__action-button">
                    <tui-icon icon="@tui.pencil" />
                  </button>
                  <button
                    type="button"
                    tuiButton
                    appearance="flat"
                    size="s"
                    (click)="deleteSeason(season)"
                    class="global-settings-tab__action-button global-settings-tab__action-button--delete">
                    <tui-icon icon="@tui.trash" />
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

<ng-template #seasonDialog let-observer>
  <form (ngSubmit)="observer.next({ year: seasonFormYear(), description: seasonFormDescription(), iscurrent: seasonFormIsCurrent() }); observer.complete()">
    <div class="global-settings-tab__form-field">
      <tui-textfield>
        <label tuiLabel>Year</label>
        <input
          type="number"
          placeholder="Enter year"
          [(ngModel)]="seasonFormYear"
          name="seasonYear"
          required />
      </tui-textfield>
    </div>
    <div class="global-settings-tab__form-field">
      <tui-textfield>
        <label tuiLabel>Description (optional)</label>
        <input
          type="text"
          placeholder="Enter description"
          [(ngModel)]="seasonFormDescription"
          name="seasonDescription" />
      </tui-textfield>
    </div>
    <div class="global-settings-tab__form-checkbox">
      <label class="global-settings-tab__checkbox-label">
        <input
          type="checkbox"
          [(ngModel)]="seasonFormIsCurrent"
          name="seasonIsCurrent" />
        <span>Set as Current Season</span>
      </label>
    </div>
    <div class="global-settings-tab__dialog-actions">
      <button type="button" tuiButton appearance="flat" (click)="observer.complete()">
        Cancel
      </button>
      <button type="submit" tuiButton appearance="primary" [disabled]="!seasonFormYear()">
        {{ editingSeason() ? 'Save' : 'Create' }}
      </button>
    </div>
  </form>
</ng-template>
