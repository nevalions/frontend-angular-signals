<div class="roles-tab">
  <div class="roles-tab__section-header">
    <h3 class="roles-tab__section-title">Roles</h3>
    <div class="roles-tab__search-container">
      <tui-textfield iconStart="@tui.search" class="roles-tab__search-input">
        <label tuiLabel>Search roles</label>
        <input
          placeholder="Search by name or description..."
          tuiTextfield
          [value]="roleSearchQuery()"
          (input)="onRoleSearchChange($any($event.target).value)" />
      </tui-textfield>
      @if (roleSearchQuery()) {
        <button
          type="button"
          tuiButton
          appearance="flat"
          size="s"
          (click)="clearRoleSearch()"
          class="roles-tab__search-clear">
          <tui-icon icon="@tui.close" />
        </button>
      }
    </div>
    <button
      type="button"
      tuiButton
      appearance="flat"
      iconStart="@tui.plus"
      (click)="addRole()"
      class="roles-tab__add-button">
      Add Role
    </button>
  </div>

  @if (rolesLoading()) {
    <div class="roles-tab__role-list">
      @for (_ of skeletonCount(); track $index) {
        <div class="roles-tab__role-card" tuiCardLarge>
          <div class="roles-tab__role-info">
            <h3 class="roles-tab__role-name" [tuiSkeleton]="true">Role name placeholder</h3>
            <p class="roles-tab__role-description" [tuiSkeleton]="10">Role description placeholder</p>
          </div>
          <div class="roles-tab__role-actions">
            <button
              type="button"
              tuiButton
              appearance="flat"
              size="s"
              class="roles-tab__action-button"
              [tuiSkeleton]="true">
              <tui-icon icon="@tui.pencil" />
            </button>
            <button
              type="button"
              tuiButton
              appearance="flat"
              size="s"
              class="roles-tab__action-button roles-tab__action-button--delete"
              [tuiSkeleton]="true">
              <tui-icon icon="@tui.trash" />
            </button>
          </div>
        </div>
      }
    </div>
  } @else if (rolesError()) {
    <div class="roles-tab__error">{{ rolesError() }}</div>
  } @else if (roles().length === 0) {
    <p class="roles-tab__empty-message">No roles found</p>
  } @else {
    <div class="roles-tab__role-list">
      @for (role of roles(); track role.id) {
        <div class="roles-tab__role-card" tuiCardLarge>
          <div class="roles-tab__role-info">
            <h3 class="roles-tab__role-name">{{ role.name }}</h3>
            @if (role.description) {
              <p class="roles-tab__role-description">{{ role.description }}</p>
            }
          </div>
          <div class="roles-tab__role-actions">
            <button
              type="button"
              tuiButton
              appearance="flat"
              size="s"
              (click)="editRole(role)"
              class="roles-tab__action-button">
              <tui-icon icon="@tui.pencil" />
            </button>
            <button
              type="button"
              tuiButton
              appearance="flat"
              size="s"
              (click)="deleteRole(role)"
              class="roles-tab__action-button roles-tab__action-button--delete">
              <tui-icon icon="@tui.trash" />
            </button>
          </div>
        </div>
      }
    </div>
  }

  @if (rolesApiTotalPages > 1) {
    <div class="roles-tab__pagination-wrapper">
      <div class="roles-tab__items-per-page">
        <span>Items per page:</span>
        @for (option of itemsPerPageOptions; track option) {
          <button
            type="button"
            tuiButton
            [appearance]="rolesItemsPerPage() === option ? 'primary' : 'outline'"
            size="xs"
            class="roles-tab__items-option"
            (click)="onRolesItemsPerPageChange(option)">
            {{ option }}
          </button>
        }
      </div>
      <div class="roles-tab__pagination">
        <tui-pagination
          [length]="rolesApiTotalPages"
          [index]="rolesCurrentPage() - 1"
          (indexChange)="onRolesPageChange($any($event))" />
      </div>
    </div>
  }

  <div class="roles-tab__section-header roles-tab__section-header--users">
    <div class="roles-tab__header-top">
      <h3 class="roles-tab__section-title">Users</h3>
      <div class="roles-tab__search-container">
        <tui-textfield iconStart="@tui.search" class="roles-tab__search-input">
          <label tuiLabel>Search users</label>
          <input
            placeholder="Search by name or email..."
            tuiTextfield
            [value]="userSearchQuery()"
            (input)="onUserSearchChange($any($event.target).value)" />
        </tui-textfield>
        @if (userSearchQuery()) {
          <button
            type="button"
            tuiButton
            appearance="flat"
            size="s"
            (click)="clearUserSearch()"
            class="roles-tab__search-clear">
            <tui-icon icon="@tui.close" />
          </button>
        }
      </div>
    </div>
    <div class="roles-tab__filters">
      <tui-textfield tuiChevron class="roles-tab__filter-select">
        <label tuiLabel>Filter by role</label>
        <input
          placeholder="All roles"
          tuiSelect
          [(ngModel)]="selectedRoleFilter" />
        <tui-data-list *tuiTextfieldDropdown>
          @for (role of roles(); track role.id) {
            <button new tuiOption type="button" [value]="role.name">
              {{ role.name }}
            </button>
          }
        </tui-data-list>
      </tui-textfield>
      <tui-textfield tuiChevron [stringify]="stringifyOnlineFilter" class="roles-tab__filter-select">
        <label tuiLabel>Filter by status</label>
        <input
          placeholder="All"
          tuiSelect
          [(ngModel)]="selectedOnlineFilter" />
        <tui-data-list *tuiTextfieldDropdown>
          @for (option of onlineFilterOptions; track option.value) {
            <button new tuiOption type="button" [value]="option.value">
              {{ option.label }}
            </button>
          }
        </tui-data-list>
      </tui-textfield>
    </div>
  </div>

  @if (usersLoading()) {
    <div class="roles-tab__user-list">
      @for (_ of userSkeletonCount(); track $index) {
        <div class="roles-tab__user-card">
          <div class="roles-tab__skeleton-user-card">
            <div class="roles-tab__skeleton-avatar" [tuiSkeleton]="true"></div>
            <div class="roles-tab__skeleton-info">
              <div class="roles-tab__skeleton-username" [tuiSkeleton]="15"></div>
              <div class="roles-tab__skeleton-email" [tuiSkeleton]="25"></div>
              <div class="roles-tab__skeleton-details">
                <div class="roles-tab__skeleton-badge" [tuiSkeleton]="true"></div>
                <div class="roles-tab__skeleton-badge" [tuiSkeleton]="true"></div>
                <div class="roles-tab__skeleton-badge" [tuiSkeleton]="true"></div>
              </div>
            </div>
          </div>
          <button
            type="button"
            tuiButton
            appearance="flat"
            size="s"
            class="roles-tab__add-role-button"
            [tuiSkeleton]="true">
            Add Role
          </button>
        </div>
      }
    </div>
  } @else if (usersError()) {
    <div class="roles-tab__error">{{ usersError() }}</div>
  } @else if (users().length === 0) {
    <p class="roles-tab__empty-message">No users found</p>
  } @else {
    <div class="roles-tab__user-list">
      @for (user of users(); track user.id) {
        <div class="roles-tab__user-card">
          <app-user-card
            [user]="user"
            [showOnlineStatus]="true"
            [showAccountStatus]="true"
            [showMemberSince]="true"
            [showLastOnline]="true"
            [showEditButton]="false"
            [showRemoveButton]="false" />
          <button
            type="button"
            tuiButton
            appearance="flat"
            size="s"
            (click)="addUserRole(user)"
            class="roles-tab__add-role-button">
            <tui-icon icon="@tui.plus" />
            Add Role
          </button>
        </div>
      }
    </div>
  }

  @if (usersApiTotalPages > 1) {
    <div class="roles-tab__pagination-wrapper">
      <div class="roles-tab__items-per-page">
        <span>Items per page:</span>
        @for (option of itemsPerPageOptions; track option) {
          <button
            type="button"
            tuiButton
            [appearance]="usersItemsPerPage() === option ? 'primary' : 'outline'"
            size="xs"
            class="roles-tab__items-option"
            (click)="onUsersItemsPerPageChange(option)">
            {{ option }}
          </button>
        }
      </div>
      <div class="roles-tab__pagination">
        <tui-pagination
          [length]="usersApiTotalPages"
          [index]="usersCurrentPage() - 1"
          (indexChange)="onUsersPageChange($any($event))" />
      </div>
    </div>
  }
</div>

<ng-template #selectRoleDialog let-observer>
  <p class="roles-tab__dialog-title">Select a role to add to <strong>{{ userToAddRole()?.username || userToAddRole()?.email }}</strong></p>
  <tui-textfield tuiChevron class="roles-tab__role-select" [stringify]="stringifyRole">
    <label tuiLabel>Role</label>
    <input
      placeholder="Select role"
      tuiSelect
      [(ngModel)]="selectedRoleToAdd" />
    <tui-data-list *tuiTextfieldDropdown>
      @for (role of roles(); track role.id) {
        <button new tuiOption type="button" [value]="role.id">
          {{ role.name }}
        </button>
      }
    </tui-data-list>
  </tui-textfield>
  <div class="roles-tab__dialog-actions">
    <button type="button" tuiButton appearance="flat" (click)="observer.complete()">
      Cancel
    </button>
    <button
      type="button"
      tuiButton
      appearance="primary"
      [disabled]="!selectedRoleToAdd()"
      (click)="observer.next(selectedRoleToAdd()); observer.complete()">
      Add Role
    </button>
  </div>
</ng-template>

<ng-template #roleDialog let-observer>
  <form (ngSubmit)="observer.next({ name: roleName(), description: roleDescription() }); observer.complete()">
    <div class="roles-tab__form-field">
      <tui-textfield>
        <label tuiLabel>Role name</label>
        <input
          placeholder="Enter role name"
          [(ngModel)]="roleName"
          name="roleName"
          required />
      </tui-textfield>
    </div>
    <div class="roles-tab__form-field">
      <tui-textfield>
        <label tuiLabel>Description (optional)</label>
        <input
          placeholder="Enter description"
          [(ngModel)]="roleDescription"
          name="roleDescription" />
      </tui-textfield>
    </div>
    <div class="roles-tab__dialog-actions">
      <button type="button" tuiButton appearance="flat" (click)="observer.complete()">
        Cancel
      </button>
      <button type="submit" tuiButton appearance="primary" [disabled]="!roleName()">
        {{ editingRole() ? 'Save' : 'Create' }}
      </button>
    </div>
  </form>
</ng-template>
