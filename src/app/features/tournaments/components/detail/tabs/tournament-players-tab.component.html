<div class="tournament-players-tab">
  <div class="tournament-players-tab__header-with-actions">
    <div class="tournament-players-tab__search-container">
      <tui-textfield iconStart="@tui.search">
        <label tuiLabel>Search players</label>
        <input
          placeholder="Search by name..."
          tuiTextfield
          [value]="playersSearch()"
          (input)="onPlayersSearchChange($any($event.target).value)"
        />
      </tui-textfield>
      @if (playersSearch()) {
        <button
          type="button"
          tuiButton
          appearance="flat"
          iconStart="@tui.close"
          size="s"
          (click)="clearPlayersSearch()"
          class="tournament-players-tab__search-clear">
        </button>
      }
    </div>
    <button
      type="button"
      tuiButton
      appearance="flat"
      iconStart="@tui.plus"
      (click)="toggleAddPlayerForm()"
      class="tournament-players-tab__add-button">
      @if (showAddPlayerForm()) {
        Cancel
      } @else {
        Add Player
      }
    </button>
  </div>

  @if (showAddPlayerForm()) {
    <div class="tournament-players-tab__add-player-form">
      <div class="tournament-players-tab__form-row">
        <tui-textfield
          tuiChevron
          iconStart="@tui.search"
          [stringify]="stringifyPlayer"
          tuiTextfieldSize="m">
          <label tuiLabel>Select Player</label>
            <input
              placeholder="Search and select player to add..."
              tuiComboBox
              [(ngModel)]="selectedPlayer"
              [disabled]="playersWithoutTeamLoading()" />
          <tui-data-list *tuiTextfieldDropdown size="l" class="tournament-players-tab__dropdown-list">
            @if (playersWithoutTeamLoading()) {
              <div class="tournament-players-tab__dropdown-loading">Loading players...</div>
            } @else if (playersWithoutTeamError()) {
              <div class="tournament-players-tab__dropdown-error">{{ playersWithoutTeamError() }}</div>
            } @else if (playersWithoutTeam().length === 0) {
              <div class="tournament-players-tab__dropdown-empty">No available players</div>
            } @else {
              @for (player of playersWithoutTeam() | tuiFilterByInput; track player.id) {
                <button
                  new
                  tuiOption
                  type="button"
                  [value]="player"
                  class="tournament-players-tab__player-option">
                  {{ stringifyPlayer(player) }}
                </button>
              }
            }
          </tui-data-list>
        </tui-textfield>
      </div>
      <div class="tournament-players-tab__form-actions">
        <button
          type="button"
          tuiButton
          appearance="primary"
          (click)="addPlayer()"
          [disabled]="!selectedPlayer()">
          Add Player
        </button>
        <button
          type="button"
          tuiButton
          appearance="flat"
          (click)="cancelAddPlayer()">
          Cancel
        </button>
      </div>
    </div>
  }

  <div class="tournament-players-tab__sort-controls">
    <button
      type="button"
      tuiButton
      appearance="flat"
      size="s"
      class="sort-button"
      iconEnd="playersSortOrder() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'"
      (click)="togglePlayersSort()">
      Sort by Name
    </button>
  </div>

  @if (playersLoading()) {
    <div class="tournament-players-tab__loading">Loading players...</div>
  } @else if (playersError()) {
    <div class="tournament-players-tab__error">{{ playersError() }}</div>
  } @else if (players().length === 0) {
    <p class="tournament-players-tab__empty-message">No players found for this tournament</p>
  } @else {
    <div class="tournament-players-tab__player-list">
      @for (player of players(); track player.id) {
        <button
          class="tournament-players-tab__player-card"
          tuiCardLarge
          tuiCell="l"
          (click)="navigateToPlayerDetail(player.player_id)">
          <tui-avatar
            size="l"
            [round]="true"
            [src]="player.person_photo_icon_url"
            class="tournament-players-tab__player-avatar">
            @if (!player.person_photo_icon_url && player.first_name && player.second_name) {
              {{ capitalizeName(player.first_name)[0].toUpperCase() }}{{ capitalizeName(player.second_name)[0].toUpperCase() }}
            }
          </tui-avatar>
          <div class="tournament-players-tab__player-content">
            <h3 class="tournament-players-tab__player-name">
              <span class="second-name">{{ capitalizeName(player.second_name || '') }}</span>
              <span class="first-name">{{ capitalizeName(player.first_name || '') }}</span>
            </h3>
            @if (player.player_team_tournament_eesl_id) {
              <p class="tournament-players-tab__player-eesl-id">EESL ID: {{ player.player_team_tournament_eesl_id }}</p>
            }
            <div class="tournament-players-tab__editable-field">
              <label class="tournament-players-tab__field-label">Team</label>
              <tui-textfield
                tuiChevron
                [stringify]="stringifyTeam"
                tuiTextfieldSize="s"
                class="tournament-players-tab__combobox">
                <label tuiLabel>Select team</label>
                <input
                  placeholder="No team"
                  tuiComboBox
                  [(ngModel)]="player.team_id"
                  (ngModelChange)="updatePlayerTeam(player.player_id, $event)"
                  [disabled]="tournamentTeamsLoading()" />
                <tui-data-list *tuiTextfieldDropdown class="tournament-players-tab__dropdown-list">
                  @if (tournamentTeamsLoading()) {
                    <div class="tournament-players-tab__dropdown-loading">Loading teams...</div>
                  } @else if (tournamentTeamsError()) {
                    <div class="tournament-players-tab__dropdown-error">{{ tournamentTeamsError() }}</div>
                  } @else if (tournamentTeams().length === 0) {
                    <div class="tournament-players-tab__dropdown-empty">No teams available</div>
                  } @else {
                    <button
                      new
                      tuiOption
                      type="button"
                      [value]="null"
                      class="tournament-players-tab__option">
                      No team
                    </button>
                    @for (team of tournamentTeams() | tuiFilterByInput; track team.id) {
                      <button
                        new
                        tuiOption
                        type="button"
                        [value]="team.id"
                        class="tournament-players-tab__option">
                        {{ stringifyTeam(team) }}
                      </button>
                    }
                  }
                </tui-data-list>
              </tui-textfield>
            </div>
            <div class="tournament-players-tab__editable-field">
              <label class="tournament-players-tab__field-label">Number</label>
              <tui-textfield tuiTextfieldSize="s" class="tournament-players-tab__textfield">
                <label tuiLabel>Player number</label>
                <input
                  placeholder="#"
                  tuiTextfield
                  [(ngModel)]="player.player_number"
                  (blur)="updatePlayerNumber(player.player_id, player.player_number)" />
              </tui-textfield>
            </div>
            <div class="tournament-players-tab__editable-field">
              <label class="tournament-players-tab__field-label">Position</label>
              <tui-textfield
                tuiChevron
                [stringify]="stringifyPosition"
                tuiTextfieldSize="s"
                class="tournament-players-tab__combobox">
                <label tuiLabel>Select position</label>
                <input
                  placeholder="No position"
                  tuiComboBox
                  [(ngModel)]="player.position_id"
                  (ngModelChange)="updatePlayerPosition(player.player_id, $event)"
                  [disabled]="sportPositionsLoading()" />
                <tui-data-list *tuiTextfieldDropdown class="tournament-players-tab__dropdown-list">
                  @if (sportPositionsLoading()) {
                    <div class="tournament-players-tab__dropdown-loading">Loading positions...</div>
                  } @else if (sportPositionsError()) {
                    <div class="tournament-players-tab__dropdown-error">{{ sportPositionsError() }}</div>
                  } @else if (sportPositions().length === 0) {
                    <div class="tournament-players-tab__dropdown-empty">No positions available</div>
                  } @else {
                    <button
                      new
                      tuiOption
                      type="button"
                      [value]="null"
                      class="tournament-players-tab__option">
                      No position
                    </button>
                    @for (position of sportPositions() | tuiFilterByInput; track position.id) {
                      <button
                        new
                        tuiOption
                        type="button"
                        [value]="position.id"
                        class="tournament-players-tab__option">
                        {{ stringifyPosition(position) }}
                      </button>
                    }
                  }
                </tui-data-list>
              </tui-textfield>
            </div>
          </div>
        </button>
      }
    </div>

    @if (playersTotalPages() > 1) {
      <div class="tournament-players-tab__pagination-wrapper">
        <div class="tournament-players-tab__items-per-page">
          <span>Items per page:</span>
          @for (option of itemsPerPageOptions; track option) {
            <button
              type="button"
              tuiButton
              class="tournament-players-tab__items-option"
              [class.tournament-players-tab__items-option--active]="playersItemsPerPage() === option"
              (click)="onPlayersItemsPerPageChange(option)">
              {{ option }}
            </button>
          }
        </div>
        <div class="tournament-players-tab__pagination">
          <tui-pagination
            [length]="playersTotalPages()"
            [index]="playersCurrentPage() - 1"
            (indexChange)="onPlayersPageChange($event)" />
        </div>
      </div>
    }
  }
</div>
