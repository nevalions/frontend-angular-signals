<div class="tournament-players-tab">
  <div class="tournament-players-tab__header-with-actions">
    <div class="tournament-players-tab__search-container">
      <tui-textfield iconStart="@tui.search">
        <label tuiLabel>Search players</label>
        <input
          placeholder="Search by name..."
          tuiTextfield
          [value]="playersSearch()"
          (input)="onPlayersSearchChange($any($event.target).value)"
        />
      </tui-textfield>
    </div>
    <button
      type="button"
      tuiButton
      appearance="flat"
      iconStart="@tui.plus"
      (click)="openAddPlayerDialog()"
      class="tournament-players-tab__add-button">
      Add Player
    </button>
  </div>

  <div class="tournament-players-tab__sort-controls">
    <button
      type="button"
      tuiButton
      appearance="flat"
      size="s"
      class="sort-button"
      iconEnd="playersSortOrder() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'"
      (click)="togglePlayersSort()">
      Sort by Name
    </button>
  </div>

  @if (playersLoading()) {
    <div class="tournament-players-tab__loading">Loading players...</div>
  } @else if (playersError()) {
    <div class="tournament-players-tab__error">{{ playersError() }}</div>
  } @else if (players().length === 0) {
    <p class="tournament-players-tab__empty-message">No players found for this tournament</p>
  } @else {
    <div class="tournament-players-tab__player-list">
      @for (player of players(); track player.id) {
        <button
          class="tournament-players-tab__player-card"
          tuiCardLarge
          tuiCell="l"
          (click)="navigateToPlayerDetail(player.player_id)">
          <tui-avatar
            size="l"
            [round]="true"
            [src]="playerPhotoIconUrl(player)"
            class="tournament-players-tab__player-avatar">
            @if (!playerPhotoIconUrl(player) && player.first_name && player.second_name) {
              {{ capitalizeName(player.first_name)[0].toUpperCase() }}{{ capitalizeName(player.second_name)[0].toUpperCase() }}
            }
          </tui-avatar>
          <div class="tournament-players-tab__player-content">
            <h3 class="tournament-players-tab__player-name">
              <span class="second-name">{{ capitalizeName(player.second_name || '') }}</span>
              <span class="first-name">{{ capitalizeName(player.first_name || '') }}</span>
            </h3>
            @if (player.player_team_tournament_eesl_id) {
              <p class="tournament-players-tab__player-eesl-id">EESL ID: {{ player.player_team_tournament_eesl_id }}</p>
            }
            @if (player.team_title) {
              <p class="tournament-players-tab__player-team">Team: {{ player.team_title | uppercase }}</p>
            }
            @if (player.position_title) {
              <p class="tournament-players-tab__player-position">Position: {{ player.position_title }}</p>
            }
            @if (player.player_number) {
              <p class="tournament-players-tab__player-number">#{{ player.player_number }}</p>
            }
          </div>
        </button>
      }
    </div>

    @if (playersTotalPages() > 1) {
      <div class="tournament-players-tab__pagination-wrapper">
        <div class="tournament-players-tab__items-per-page">
          <span>Items per page:</span>
          @for (option of itemsPerPageOptions; track option) {
            <button
              type="button"
              tuiButton
              class="tournament-players-tab__items-option"
              [class.tournament-players-tab__items-option--active]="playersItemsPerPage() === option"
              (click)="onPlayersItemsPerPageChange(option)">
              {{ option }}
            </button>
          }
        </div>
        <div class="tournament-players-tab__pagination">
          <tui-pagination
            [length]="playersTotalPages()"
            [index]="playersCurrentPage() - 1"
            (indexChange)="onPlayersPageChange($event)" />
        </div>
      </div>
    }
  }

  @if (addPlayerDialogOpen()) {
    <div class="tournament-players-tab__modal-overlay">
      <div class="tournament-players-tab__modal">
        <div class="tournament-players-tab__modal-header">
          <h2>Add Player to Tournament</h2>
          <button
            type="button"
            tuiButtonClose
            tuiIconButton
            appearance="flat"
            (click)="closeAddPlayerDialog()">
          </button>
        </div>
        <div class="tournament-players-tab__modal-body">
          <div class="tournament-players-tab__modal-search">
            <tui-textfield iconStart="@tui.search">
              <label tuiLabel>Search available players</label>
              <input
                placeholder="Search by name..."
                tuiTextfield
                [value]="availablePlayersSearch()"
                (input)="onAvailablePlayersSearchChange($any($event.target).value)" />
            </tui-textfield>
          </div>

          @if (availablePlayersLoading()) {
            <div class="tournament-players-tab__modal-loading">Loading available players...</div>
          } @else if (availablePlayersError()) {
            <div class="tournament-players-tab__modal-error">{{ availablePlayersError() }}</div>
          } @else if (filteredAvailablePlayers().length === 0) {
            <div class="tournament-players-tab__modal-empty">No available players found</div>
          } @else {
            <div class="tournament-players-tab__modal-player-list">
              @for (player of filteredAvailablePlayers(); track player.id) {
                <button
                  [class.tournament-players-tab__modal-player-card--selected]="selectedPlayerId() === player.id"
                  class="tournament-players-tab__modal-player-card"
                  (click)="selectPlayer(player.id)">
                  <tui-avatar
                    size="m"
                    [round]="true"
                    [src]="availablePlayerPhotoIconUrl(player)"
                    class="tournament-players-tab__modal-player-avatar">
                    @if (!availablePlayerPhotoIconUrl(player) && player.person.first_name && player.person.second_name) {
                      {{ capitalizeAvailablePlayerName(player.person.first_name)[0].toUpperCase() }}{{ capitalizeAvailablePlayerName(player.person.second_name)[0].toUpperCase() }}
                    }
                  </tui-avatar>
                  <div class="tournament-players-tab__modal-player-content">
                    <span class="tournament-players-tab__modal-player-name">
                      {{ capitalizeAvailablePlayerName(player.person.second_name || '') }} {{ capitalizeAvailablePlayerName(player.person.first_name || '') }}
                    </span>
                    @if (player.player_eesl_id) {
                      <span class="tournament-players-tab__modal-player-eesl-id">EESL ID: {{ player.player_eesl_id }}</span>
                    }
                  </div>
                </button>
              }
            </div>
          }
        </div>
        <div class="tournament-players-tab__modal-footer">
          <button
            type="button"
            tuiButton
            appearance="flat"
            (click)="closeAddPlayerDialog()">
            Cancel
          </button>
          <button
            type="button"
            tuiButton
            appearance="primary"
            [disabled]="!selectedPlayerId()"
            (click)="addPlayerToTournament()">
            Add Player
          </button>
        </div>
      </div>
    </div>
  }
</div>
