<app-collapsible-section title="Score Controls" sectionKey="scoreboard-score">
  <ng-template>
    <div class="score-forms">
      <!-- Quarter Selection -->
      <div class="quarter-section">
        <tui-textfield tuiChevron class="quarter-select" [stringify]="quarterStringify">
          <label tuiLabel>{{ periodFieldLabel() }}</label>
          <input
            tuiSelect
            [ngModel]="selectedQtr()"
            (ngModelChange)="selectedQtr.set($event)"
            [placeholder]="'Select ' + periodFieldLabel().toLowerCase()"
          />
          <tui-data-list *tuiTextfieldDropdown size="l">
            @for (qtr of periodOptions(); track qtr) {
              <button new tuiOption type="button" [value]="qtr">{{ quarterStringify(qtr) }}</button>
            }
          </tui-data-list>
        </tui-textfield>
      </div>

      <!-- Score Panel: Two teams side by side -->
      <div class="score-panel">
        @for (team of teamConfig; track team.key) {
          <div class="team-panel" [class]="team.class">
            <div class="team-header">
              <span class="team-label">{{ team.label }}</span>
              <div class="header-buttons">
                <button
                  tuiButton
                  type="button"
                  [appearance]="team.touchdownCalled() ? 'accent' : 'outline'"
                  size="s"
                  title="Touchdown Called"
                  class="td-toggle-button"
                  [class.td-active]="team.touchdownCalled()"
                  (click)="team.toggleTouchdown()"
                >
                  <span class="td-icon">üèà</span>
                  <span class="td-text">TD</span>
                </button>

                <button
                  tuiButton
                  type="button"
                  [appearance]="team.timeoutCalled() ? 'accent' : 'outline'"
                  size="s"
                  title="Timeout Called"
                  class="to-toggle-button"
                  [class.to-active]="team.timeoutCalled()"
                  (click)="team.toggleTimeout()"
                  [style.visibility]="supportsTimeouts() ? 'visible' : 'hidden'"
                >
                  <span class="to-icon">‚è±Ô∏è</span>
                  <span class="to-text">TO</span>
                </button>
              </div>
            </div>

            <!-- Large Score Display -->
            <div class="score-display" [style.background-color]="team.key === 'a' ? teamColorA() + '20' : teamColorB() + '20'">
              <span class="score-value">{{ team.pendingScore() }}</span>
            </div>

             <!-- Quick Score Buttons - Large Touch Targets -->
            <div class="quick-buttons">
              @for (btn of quickScoreButtons; track btn.label) {
                <button
                  tuiButton
                  type="button"
                  [appearance]="btn.value > 0 ? 'secondary' : 'outline'"
                  size="l"
                  [title]="btn.title"
                  class="quick-btn"
                  [class.pulse-plus]="(lastPulse()?.kind === 'score') && (lastPulse()?.team === team.key) && (lastPulse()?.delta === btn.value) && (btn.value > 0)"
                  [class.pulse-minus]="(lastPulse()?.kind === 'score') && (lastPulse()?.team === team.key) && (lastPulse()?.delta === btn.value) && (btn.value < 0)"
                  (click)="team.onQuickScore(btn.value)"
                >
                  {{ btn.label }}
                </button>
              }
            </div>

            <!-- Timeout Controls -->
            @if (supportsTimeouts()) {
              <div class="timeout-controls">
                <div class="timeout-indicators">
                  @for (available of (team.key === 'a' ? indicatorsTeamA() : indicatorsTeamB()); track $index) {
                    <span
                      class="timeout-indicator"
                      [class.available]="available"
                      [class.used]="!available"
                    ></span>
                  }
                </div>

                <div class="timeout-buttons">
                  <button
                    tuiButton
                    type="button"
                    appearance="destructive"
                    size="s"
                    [disabled]="(team.key === 'a' ? timeoutsTeamA() : timeoutsTeamB()) === 0"
                    (click)="onUseTimeout(team.key)"
                    title="Use Timeout"
                    [class.pulse-minus]="(lastPulse()?.kind === 'timeout') && (lastPulse()?.team === team.key) && (lastPulse()?.delta === -1)"
                  >
                    <tui-icon icon="@tui.minus" />
                    TO
                  </button>

                  <button
                    tuiButton
                    type="button"
                    appearance="secondary"
                    size="s"
                    [disabled]="(team.key === 'a' ? timeoutsTeamA() : timeoutsTeamB()) === 3"
                    (click)="onRestoreTimeout(team.key)"
                    title="Restore Timeout"
                    [class.pulse-plus]="(lastPulse()?.kind === 'timeout') && (lastPulse()?.team === team.key) && (lastPulse()?.delta === 1)"
                  >
                    <tui-icon icon="@tui.plus" />
                    TO
                  </button>

                  <button
                    tuiButton
                    type="button"
                    appearance="outline"
                    size="s"
                    (click)="onResetTimeouts(team.key)"
                    title="Reset All Timeouts"
                  >
                    Reset
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Manual Score Edit (collapsed by default, for corrections) -->
      <div class="manual-edit">
        <button
          tuiButton
          type="button"
          appearance="flat"
          size="m"
          class="manual-edit-toggle"
          (click)="manualEditExpanded.set(!manualEditExpanded())"
        >
          <tui-icon [icon]="manualEditExpanded() ? '@tui.chevron-up' : '@tui.chevron-down'" />
          <span>Manual Score Edit</span>
        </button>
        
        @if (manualEditExpanded()) {
          <div class="manual-edit-content">
            @for (team of teamConfig; track team.key) {
              <div class="manual-input-row">
                <span class="input-label">{{ team.label }}</span>
                <tui-textfield class="score-input">
                  <input
                    tuiInputNumber
                    [ngModel]="team.pendingScore()"
                    [min]="0"
                    [max]="199"
                    [step]="1"
                    (ngModelChange)="team.onChange($event)"
                  />
                </tui-textfield>
              </div>
            }
            <!-- Save Button inside Manual Edit -->
            <button
              tuiButton
              type="button"
              appearance="primary"
              size="l"
              class="save-button"
              [disabled]="!hasChanges()"
              (click)="onSave()"
            >
              Save Score Changes
            </button>
          </div>
        }
      </div>
    </div>
  </ng-template>
</app-collapsible-section>
